<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ONVIF Camera Controller</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Helvetica, Arial, sans-serif;
				display: flex;
				align-items: center;
				justify-content: center;
				flex-direction: column;
				margin: 20px;
				background-color: #f0f2f5;
			}
			.container {
				text-align: center;
				background: white;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			}
			.video-wrapper {
				margin-bottom: 20px;
				background-color: #000;
				display: inline-block;
				border-radius: 4px;
				overflow: hidden;
			}
			img {
				max-width: 100%;
				height: auto;
				display: block;
			}
			.controls {
				display: grid;
				grid-template-columns: 70px 70px 70px;
				grid-template-rows: 70px 70px;
				gap: 10px;
				justify-content: center;
			}
			.controls button {
				font-size: 2em;
				border: 1px solid #ccc;
				border-radius: 8px;
				background-color: #f7f7f7;
				cursor: pointer;
				user-select: none; /* Prevents text selection on hold */
				-webkit-user-select: none; /* For Safari */
			}
			.controls button:active {
				background-color: #e0e0e0;
				border-color: #999;
			}
			/* Grid positioning for the D-pad */
			.btn-up {
				grid-column: 2;
				grid-row: 1;
			}
			.btn-left {
				grid-column: 1;
				grid-row: 2;
			}
			.btn-right {
				grid-column: 3;
				grid-row: 2;
			}
			.btn-down {
				grid-column: 2;
				grid-row: 2;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Camera Controller</h1>
			<div class="video-wrapper">
				<!--
              !!! IMPORTANT !!!
              This is the MJPEG stream from your camera.
              The browser needs to authenticate directly with the camera for this video feed.
              I have filled this in using the credentials from your server config.
            -->
				<img
					src="http://192.168.0.103/mjpeg/stream.cgi?user=WjSR8Qq0&pwd=vBjeL7SgR8gquU"
					alt="Live Camera Feed (If broken, check credentials in HTML)"
					onerror="this.alt='Error: Could not load video stream. Check camera IP and credentials in the HTML file.'"
				/>
			</div>

			<div class="controls">
				<button class="ptz-btn btn-up" data-direction="up">▲</button>
				<button class="ptz-btn btn-left" data-direction="left">◄</button>
				<button class="ptz-btn btn-right" data-direction="right">►</button>
				<button class="ptz-btn btn-down" data-direction="down">▼</button>
			</div>
		</div>

		<script>
			// Select all buttons with the 'ptz-btn' class
			document.querySelectorAll('.ptz-btn').forEach((button) => {
				const direction = button.dataset.direction;

				// This function sends the command to your Node.js server
				const sendCommand = (action) => {
					console.log(`Sending action: ${action}, direction: ${direction}`);
					fetch('/api/ptz', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ direction, action }),
					})
						.then((response) => {
							if (!response.ok) {
								console.error('Failed to send PTZ command');
							}
						})
						.catch((error) => console.error('Network error:', error));
				};

				// --- Event Listeners for Mouse and Touch ---

				// When the mouse button is pressed down, start moving
				button.addEventListener('mousedown', () => sendCommand('start'));
				// When the mouse button is released, stop moving
				button.addEventListener('mouseup', () => sendCommand('stop'));
				// IMPORTANT: If the mouse leaves the button while pressed, also stop
				button.addEventListener('mouseleave', () => sendCommand('stop'));

				// Same logic for touch devices (phones, tablets)
				button.addEventListener('touchstart', (e) => {
					e.preventDefault(); // Prevents page scrolling on mobile
					sendCommand('start');
				});
				button.addEventListener('touchend', (e) => {
					e.preventDefault();
					sendCommand('stop');
				});
			});
		</script>
	</body>
</html>
